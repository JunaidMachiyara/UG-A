# ID/Code Structure Verification - Factory Isolation

## ‚úÖ **VERIFIED: Structure is Safe for Multi-Factory Use**

### **Core Architecture (Implemented)**

1. **Firestore Document IDs**: Auto-generated by Firestore (unique globally)
2. **Business Codes**: CSV `id` field stored as `code` field in document
3. **Factory Isolation**: All entities include `factoryId` field
4. **Uniqueness Check**: Per factory only (code must be unique within factory, not globally)

---

## üìã **Item Import Structure** ‚úÖ

### CSV Import Process:
1. **CSV `id` field** ‚Üí Stored as `code` field in document
2. **Firestore Document ID** ‚Üí Auto-generated (unique)
3. **factoryId** ‚Üí Included: `factoryId: currentFactory?.id || ''`
4. **Duplicate Check**: 
   - Checks existing items WHERE `factoryId == currentFactory.id`
   - Compares by `code` field
   - Skips items with same `code` for same factory
   - Allows same `code` across different factories

### Code Location:
- `components/DataImportExport.tsx` lines 205-224, 245-261

### Verification:
```javascript
// ‚úÖ Duplicate check per factory
const existingItemsQuery = query(itemsCollection, 
    where('factoryId', '==', currentFactory?.id || ''));

// ‚úÖ Auto-generated document ID
const itemRef = doc(collection(db, 'items'));

// ‚úÖ CSV id stored as code
const itemDataForSave = {
    ...itemData, // includes factoryId
    code: csvId || item.code || ...,
    createdAt: serverTimestamp()
};
```

---

## ü§ù **Partner Import Structure** ‚úÖ

### CSV Import Process:
1. **CSV `id` field** ‚Üí Stored as `code` field in document
2. **Firestore Document ID** ‚Üí Auto-generated (unique)
3. **factoryId** ‚Üí Included: `factoryId: currentFactory?.id || ''`
4. **Duplicate Check**:
   - Checks existing partners WHERE `factoryId == currentFactory.id`
   - Compares by both `id` and `code` fields
   - Skips partners with same `id`/`code` for same factory
   - Allows same `code` across different factories

### Code Location:
- `components/DataImportExport.tsx` lines 443-462, 480-503

### Verification:
```javascript
// ‚úÖ Duplicate check per factory
const existingPartnersQuery = query(partnersCollection, 
    where('factoryId', '==', currentFactory?.id || ''));

// ‚úÖ Auto-generated document ID
const partnerRef = doc(collection(db, 'partners'));

// ‚úÖ CSV id stored as code
const partnerDataForSave = {
    ...partnerData, // includes factoryId (from line 437)
    code: csvId,
    balance: 0,
    createdAt: serverTimestamp()
};
```

---

## ‚ö†Ô∏è **Potential Issue Found: Manual Partner Creation**

### Location:
- `context/DataContext.tsx` lines 1334-1338

### Issue:
The `addPartner` function checks for duplicate IDs globally (across all factories) instead of per factory.

### Current Code:
```javascript
const existingPartner = state.partners.find(p => p.id === partnerId);
if (existingPartner) {
    alert(`Partner ID "${partnerId}" already exists...`);
    return;
}
```

### Impact:
- **CSV imports are safe** (use auto-generated Firestore IDs)
- **Manual creation via Setup form** might reject valid codes if another factory has the same code
- **Does NOT cause overwrites** (Firestore document IDs are still unique)

### Recommendation:
Update duplicate check to include factoryId filter (low priority, doesn't cause data loss)

---

## ‚úÖ **Summary**

### **SAFE - Will NOT Overwrite:**
- ‚úÖ Items CSV import
- ‚úÖ Partners CSV import
- ‚úÖ All entities use auto-generated Firestore document IDs
- ‚úÖ All entities include `factoryId` field
- ‚úÖ Duplicate checks are per factory (for CSV imports)
- ‚úÖ Same codes can exist across different factories

### **Minor Issue (Non-Critical):**
- ‚ö†Ô∏è Manual partner creation checks duplicates globally (should be per factory)
- This doesn't cause overwrites, just might prevent valid manual entries

### **Conclusion:**
**The structure is safe for multi-factory use. Items and partners from different factories with the same business codes will NOT overwrite each other.**

---

## üîç **How to Verify After Fresh Start**

1. **Upload items for Factory A** with codes: ITEM-001, ITEM-002
2. **Upload items for Factory B** with same codes: ITEM-001, ITEM-002
3. **Expected Result**: 
   - Both factories have items with codes ITEM-001 and ITEM-002
   - Different Firestore document IDs
   - No overwrites

4. **Upload partners for Factory A** with codes: SUP-001, CUS-001
5. **Upload partners for Factory B** with same codes: SUP-001, CUS-001
6. **Expected Result**:
   - Both factories have partners with codes SUP-001 and CUS-001
   - Different Firestore document IDs
   - No overwrites













